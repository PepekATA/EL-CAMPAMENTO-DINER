# .github/workflows/sync-models.yml
# 
# Workflow que sincroniza automÃ¡ticamente:
# 1. Detecta cambios en models_metadata.json
# 2. Actualiza Vercel
# 3. Notifica a Streamlit Cloud

name: ğŸ¤– Sync Trading Models

on:
  push:
    branches: [ main ]
    paths:
      - 'models_metadata.json'
  
  # Permitir ejecuciÃ³n manual
  workflow_dispatch:
  
  # EjecuciÃ³n programada cada hora
  schedule:
    - cron: '0 * * * *'

jobs:
  sync-models:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v3
    
    - name: ğŸ” Check models metadata
      id: check_metadata
      run: |
        if [ -f "models_metadata.json" ]; then
          echo "âœ… models_metadata.json existe"
          echo "exists=true" >> $GITHUB_OUTPUT
          
          # Leer metadata
          TOTAL_MODELS=$(jq '.total_models' models_metadata.json)
          LAST_UPDATE=$(jq -r '.last_update' models_metadata.json)
          
          echo "ğŸ“Š Total modelos: $TOTAL_MODELS"
          echo "ğŸ• Ãšltima actualizaciÃ³n: $LAST_UPDATE"
          
          echo "total_models=$TOTAL_MODELS" >> $GITHUB_OUTPUT
          echo "last_update=$LAST_UPDATE" >> $GITHUB_OUTPUT
        else
          echo "âš ï¸ models_metadata.json no encontrado"
          echo "exists=false" >> $GITHUB_OUTPUT
        fi
    
    - name: ğŸ”„ Trigger Vercel Deployment
      if: steps.check_metadata.outputs.exists == 'true'
      run: |
        echo "ğŸš€ Triggering Vercel deployment..."
        curl -X POST "https://api.vercel.com/v1/integrations/deploy/${{ secrets.VERCEL_DEPLOY_HOOK }}"
    
    - name: ğŸ“¢ Notify Streamlit
      if: steps.check_metadata.outputs.exists == 'true'
      run: |
        echo "ğŸ“¢ NotificaciÃ³n enviada - Streamlit se actualizarÃ¡ automÃ¡ticamente"
        echo "   Modelos actualizados: ${{ steps.check_metadata.outputs.total_models }}"
        echo "   Timestamp: ${{ steps.check_metadata.outputs.last_update }}"
    
    - name: ğŸ“ Create deployment summary
      if: steps.check_metadata.outputs.exists == 'true'
      run: |
        echo "## ğŸ¤– Trading Bot - Sync Completed" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "âœ… **Models Updated Successfully**" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- ğŸ“Š Total Models: ${{ steps.check_metadata.outputs.total_models }}" >> $GITHUB_STEP_SUMMARY
        echo "- ğŸ• Last Update: ${{ steps.check_metadata.outputs.last_update }}" >> $GITHUB_STEP_SUMMARY
        echo "- ğŸš€ Vercel: Deploying..." >> $GITHUB_STEP_SUMMARY
        echo "- ğŸ“± Streamlit: Will auto-refresh" >> $GITHUB_STEP_SUMMARY

  notify-success:
    needs: sync-models
    runs-on: ubuntu-latest
    if: success()
    
    steps:
    - name: ğŸ‰ Success notification
      run: |
        echo "âœ… SincronizaciÃ³n completada exitosamente"
        echo "ğŸ”— Bot live: https://tu-bot.vercel.app"
        echo "ğŸ“Š Dashboard: https://share.streamlit.io/tu-usuario/trading-bot"

  notify-failure:
    needs: sync-models
    runs-on: ubuntu-latest
    if: failure()
    
    steps:
    - name: âŒ Failure notification
      run: |
        echo "âŒ Error en la sincronizaciÃ³n"
        echo "ğŸ” Revisa los logs de GitHub Actions"
